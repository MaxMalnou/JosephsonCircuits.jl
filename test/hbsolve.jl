using JosephsonCircuits
using Test

@testset verbose=true "hbsolve" begin

    @variables Rleft Cc Lj Cj w L1
    circuit = Tuple{String,String,String,Num}[]
    push!(circuit,("P1","1","0",1))
    push!(circuit,("R1","1","0",Rleft))
    push!(circuit,("C1","1","2",Cc)) 
    push!(circuit,("Lj1","2","0",Lj)) 
    push!(circuit,("C2","2","0",Cj))
    circuitdefs = Dict(
        Lj =>1000.0e-12,
        Cc => 100.0e-15,
        Cj => 1000.0e-15,
        Rleft => 50.0,
    )
    ws = 2*pi*(4.5:0.01:5.0)*1e9
    wp = 2*pi*4.75001*1e9
    Ip = 0.00565e-6
    Nsignalmodes = 8
    Npumpmodes = 8
    result=hbsolve(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

    @test isapprox(
        result.pump.nodeflux,
        ComplexF64[-0.013189736218636441 - 0.008651273221683266im, 2.6395682539011797e-5 - 5.6661514233313726e-6im, -2.3497663047131403e-8 - 2.2306503448330988e-8im, -7.990410788185173e-12 + 3.749499317166309e-11im, 4.336610521409153e-14 - 1.3388741572794773e-14im, -3.8059160268943944e-17 - 3.852723364098488e-17im, 6.07942296115915e-20 + 6.60227155809359e-21im, 5.977496795928632e-20 + 2.938144480595029e-20im, 0.12157241551965468 + 0.07973640247896553im, 1.3738923117026488e-5 - 6.46274778537762e-5im, -5.3393939365693146e-8 + 9.186223725369537e-9im, 2.790433171591809e-11 + 4.514438082272354e-11im, 3.3397076362502e-14 - 4.567840462363693e-14im, -6.153011440710407e-17 - 1.534143178629367e-17im, 6.419757193364206e-20 - 2.4735969038803813e-20im, 7.29011218720814e-20 + 2.6769912044348367e-21im],
        atol = 1e-8)

    @test isapprox(
        10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
        [0.0027170567684318336, 0.0031878910893791113, 0.003764172736760887, 0.0044752977535568025, 0.0053605959763061576, 0.0064733221021938975, 0.00788652526979293, 0.009701821078803697, 0.012062730251351263, 0.015175344096677876, 0.019340995073025724, 0.025009048387281324, 0.03286424875818319, 0.04397498273540677, 0.06005196755960492, 0.08391313445153363, 0.12034563601945997, 0.17775728001306818, 0.2714466567248869, 0.43028716192043454, 0.7107700967255848, 1.2270921144417903, 2.2162496487671177, 4.180058522554849, 8.168958508626085, 13.30072725995452, 8.179957371303482, 4.185507181701968, 2.2189397713773675, 1.228462507677842, 0.7114937277036677, 0.4306841832409538, 0.27167282453838204, 0.1778906546996149, 0.12042670939499213, 0.08396367944962557, 0.06008411216445837, 0.04399571189222961, 0.032877711778053494, 0.02501778089224741, 0.019346586912408068, 0.015178815533550454, 0.01206474985673973, 0.009702835261564286, 0.007886837147456062, 0.00647314059948161, 0.005360067018761243, 0.0044745244606336065, 0.0037632287214528454, 0.0031868293579977005, 0.0027159157639621524],
        atol = 1e-8)

end

@testset verbose=true "hbsolve lossy" begin

    @variables Rleft Cc Lj Cj w L1 Rloss
    circuit = Tuple{String,String,String,Num}[]
    push!(circuit,("P1","1","0",1))
    push!(circuit,("R1","1","0",Rleft))
    push!(circuit,("C1","1","2",Cc)) 
    push!(circuit,("Lj1","2","0",Lj)) 
    push!(circuit,("C2","2","0",Cj))
    push!(circuit,("R2","2","0",Rloss))

    circuitdefs = Dict(
        Lj =>1000.0e-12,
        Cc => 100.0e-15,
        Cj => 1000.0e-15,
        Rloss => 1000.0,
        Rleft => 50.0,
    )
    ws = 2*pi*(4.5:0.01:5.0)*1e9
    wp = 2*pi*4.75001*1e9
    Ip = 0.00565e-6
    Nsignalmodes = 8
    Npumpmodes = 8
    result=hbsolve(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

    @test isapprox(
        result.pump.nodeflux,
        ComplexF64[-0.0054041783971746 - 0.020370057382730806im, 6.815424075183076e-7 - 1.147012900366793e-6im, -1.753427490430056e-10 + 1.2486837493074984e-10im, 3.388035426864977e-14 - 5.129280878553909e-15im, -5.1298428933921494e-18 - 1.739836240646162e-18im, -4.596535957104933e-20 - 7.912243213092834e-20im, 2.0030609892972045e-20 + 5.0036217228674835e-20im, 1.794196518026824e-19 + 8.871654522001758e-20im, 0.05082751019439782 + 0.015844675018286195im, -1.8805963793270084e-6 - 2.6694074929857497e-6im, -7.987993107073292e-12 + 3.598713769919333e-10im, 2.8969986222335313e-14 - 3.756365383211586e-14im, -6.4252953140502435e-18 + 2.0797573731599905e-18im, -9.416708080413478e-20 - 5.112014012913594e-20im, 4.582330476037865e-20 + 3.9710828188645537e-20im, 2.190537485892898e-19 + 8.560855801192207e-21im],
        atol = 1e-8)

    @test isapprox(
        10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
        [-0.35881757065389075, -0.3851173962405351, -0.41414936741470204, -0.44628696672146195, -0.48196711238056517, -0.52170298700604, -0.56609984879292, -0.6158745948887158, -0.6718800569656551, -0.7351352743301984, -0.8068633192034746, -0.8885386460366157, -0.9819463922574563, -1.089256531597212, -1.2131161713226868, -1.3567633723310317, -1.5241652233566767, -1.7201806973353808, -1.9507435138455569, -2.223048843239626, -2.545704268702978, -2.9287579585295886, -3.38342158695043, -3.9211164982952336, -4.551109093896298, -5.275361876519062, -6.078360918705144, -6.909695380887424, -7.662866289218854, -8.174297242072996, -8.287679761537564, -7.968448354057507, -7.334037016227039, -6.555662948371419, -5.764285202966598, -5.030263188934635, -4.380878193531114, -3.820226533549771, -3.341958482864788, -2.9359906126572595, -2.5916850341946667, -2.2992028878025774, -2.049972675545674, -1.8367529884342717, -1.6535252962345233, -1.4953291435376725, -1.3580909298903507, -1.2384675791047277, -1.133712158184686, -1.0415620181945617, -0.9601473451970821],
        atol = 1e-8)

end