using JosephsonCircuits
using Test

@testset verbose=true "hbsolve" begin

    @variables Rleft Cc Lj Cj w L1
    circuit = Tuple{String,String,String,Num}[]
    push!(circuit,("P1","1","0",1))
    push!(circuit,("R1","1","0",Rleft))
    push!(circuit,("C1","1","2",Cc)) 
    push!(circuit,("Lj1","2","0",Lj)) 
    push!(circuit,("C2","2","0",Cj))
    circuitdefs = Dict(
        Lj =>1000.0e-12,
        Cc => 100.0e-15,
        Cj => 1000.0e-15,
        Rleft => 50.0,
    )
    ws = 2*pi*(4.5:0.01:5.0)*1e9
    wp = 2*pi*4.75001*1e9
    Ip = 0.00565e-6
    Nsignalmodes = 8
    Npumpmodes = 8
    result=hbsolve(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

    @test isapprox(
        result.pump.nodeflux,
        ComplexF64[-0.013189736218636441 - 0.008651273221683266im, 2.6395682539011797e-5 - 5.6661514233313726e-6im, -2.3497663047131403e-8 - 2.2306503448330988e-8im, -7.990410788185173e-12 + 3.749499317166309e-11im, 4.336610521409153e-14 - 1.3388741572794773e-14im, -3.8059160268943944e-17 - 3.852723364098488e-17im, 6.07942296115915e-20 + 6.60227155809359e-21im, 5.977496795928632e-20 + 2.938144480595029e-20im, 0.12157241551965468 + 0.07973640247896553im, 1.3738923117026488e-5 - 6.46274778537762e-5im, -5.3393939365693146e-8 + 9.186223725369537e-9im, 2.790433171591809e-11 + 4.514438082272354e-11im, 3.3397076362502e-14 - 4.567840462363693e-14im, -6.153011440710407e-17 - 1.534143178629367e-17im, 6.419757193364206e-20 - 2.4735969038803813e-20im, 7.29011218720814e-20 + 2.6769912044348367e-21im],
        atol = 1e-8)

    @test isapprox(
        10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
        [0.0027170567684318336, 0.0031878910893791113, 0.003764172736760887, 0.0044752977535568025, 0.0053605959763061576, 0.0064733221021938975, 0.00788652526979293, 0.009701821078803697, 0.012062730251351263, 0.015175344096677876, 0.019340995073025724, 0.025009048387281324, 0.03286424875818319, 0.04397498273540677, 0.06005196755960492, 0.08391313445153363, 0.12034563601945997, 0.17775728001306818, 0.2714466567248869, 0.43028716192043454, 0.7107700967255848, 1.2270921144417903, 2.2162496487671177, 4.180058522554849, 8.168958508626085, 13.30072725995452, 8.179957371303482, 4.185507181701968, 2.2189397713773675, 1.228462507677842, 0.7114937277036677, 0.4306841832409538, 0.27167282453838204, 0.1778906546996149, 0.12042670939499213, 0.08396367944962557, 0.06008411216445837, 0.04399571189222961, 0.032877711778053494, 0.02501778089224741, 0.019346586912408068, 0.015178815533550454, 0.01206474985673973, 0.009702835261564286, 0.007886837147456062, 0.00647314059948161, 0.005360067018761243, 0.0044745244606336065, 0.0037632287214528454, 0.0031868293579977005, 0.0027159157639621524],
        atol = 1e-8)
end
