using JosephsonCircuits
using Test

@testset verbose=true "hbsolve2" begin

    @testset "hbsolve2 lossless" begin

        @variables Rleft Cc Lj Cj w L1
        circuit = Tuple{String,String,String,Num}[]
        push!(circuit,("P1","1","0",1))
        push!(circuit,("R1","1","0",Rleft))
        push!(circuit,("C1","1","2",Cc)) 
        push!(circuit,("Lj1","2","0",Lj)) 
        push!(circuit,("C2","2","0",Cj))
        circuitdefs = Dict(
            Lj =>1000.0e-12,
            Cc => 100.0e-15,
            Cj => 1000.0e-15,
            Rleft => 50.0,
        )
        ws = 2*pi*(4.5:0.01:5.0)*1e9
        wp = 2*pi*4.75001*1e9
        Ip = 0.00565e-6
        Nsignalmodes = 8
        Npumpmodes = 8
        result=hbsolve2(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

        ## There is something wrong with hbsolve2 because the difference with v1 is
        # so large
        @test isapprox(
            result.pump.nodeflux,
            ComplexF64[-0.013189687430685906 - 0.008651135043575502im, 2.639598670538948e-5 - 5.666611449141018e-6im, -2.3498766548001166e-8 - 2.2306486650562197e-8im, -7.98943253563643e-12 + 3.749653757553431e-11im, 4.336757164454433e-14 - 1.3391103079731818e-14im, -3.805252315803626e-17 - 3.8516421942690624e-17im, -2.130449776384576e-20 + 4.618696753731368e-20im, 2.8021821773935325e-20 + 1.3775003712485063e-20im, 0.12157339027318752 + 0.07973621371698303im, 1.3738199701264974e-5 - 6.462861731089273e-5im, -5.339502035336453e-8 + 9.18771948944054e-9im, 2.7906788458648864e-11 + 4.514498872493491e-11im, 3.339678445512591e-14 - 4.568185800970342e-14im, -6.151689076374028e-17 - 1.53346634441141e-17im, 2.5039839024709762e-21 + 5.716902094904344e-20im, 3.4175801609630287e-20 + 1.2562610859448766e-21im],
            atol = 1e-8)

        @test isapprox(
            10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
            [0.002717108858946793, 0.0031879520935982402, 0.0037642446185965324, 0.004475383013223682, 0.0053606978269378535, 0.006473444715221922, 0.007886674120213068, 0.009702003437559649, 0.012062955897919649, 0.01517562636626106, 0.019341352421240222, 0.02500950676926198, 0.03286484531385613, 0.043975771610102424, 0.06005302928487789, 0.08391459137857606, 0.12034767823710302, 0.1777602097497067, 0.2714509659029194, 0.4302936705726257, 0.7107802094077564, 1.2271083440171333, 2.2162769935173308, 4.180110108877973, 8.169093934732308, 13.301163085878711, 8.180093144698343, 4.185558851579401, 2.2189671533278914, 1.2284787585772965, 0.7115038536433982, 0.43069070043494184, 0.27167713937135807, 0.1778935882792974, 0.12042875429222956, 0.08396513829127941, 0.06008517528910184, 0.043996501810995445, 0.032878309127231595, 0.025018239887281794, 0.01934694474117187, 0.015179098184663023, 0.012064975809621162, 0.009703017868664187, 0.007886986200931884, 0.006473263379761254, 0.005360169008014386, 0.00447460983580694, 0.0037633006999568362, 0.0031868904434022814, 0.002715967922848746],
            atol = 1e-8)
    end


    @testset "hbsolve2 lossy" begin

        @variables Rleft Cc Lj Cj w L1 Rloss
        circuit = Tuple{String,String,String,Num}[]
        push!(circuit,("P1","1","0",1))
        push!(circuit,("R1","1","0",Rleft))
        push!(circuit,("C1","1","2",Cc)) 
        push!(circuit,("Lj1","2","0",Lj)) 
        push!(circuit,("C2","2","0",Cj))
        push!(circuit,("R2","2","0",Rloss))

        circuitdefs = Dict(
            Lj =>1000.0e-12,
            Cc => 100.0e-15,
            Cj => 1000.0e-15,
            Rloss => 1000.0,
            Rleft => 50.0,
        )
        ws = 2*pi*(4.5:0.01:5.0)*1e9
        wp = 2*pi*4.75001*1e9
        Ip = 0.00565e-6
        Nsignalmodes = 8
        Npumpmodes = 8
        result=hbsolve2(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

        ## There is something wrong with hbsolve2 because the difference with v1 is
        # so large
        @test isapprox(
            result.pump.nodeflux,
            ComplexF64[-0.005404178917602639 - 0.02037005119475546im, 6.815437879002591e-7 - 1.1470157274338386e-6im, -1.7534339637329796e-10 + 1.248689199465629e-10im, 3.388045129223033e-14 - 5.129196354950434e-15im, -5.089423261467371e-18 - 1.895969661323808e-18im, -7.301852879518391e-21 - 1.4117946313451666e-22im, -3.774674992243524e-21 - 8.701899328456453e-21im, -2.20277547839468e-22 - 7.606927757196388e-23im, 0.05082755114111888 + 0.015844684693778203im, -1.8806013139029173e-6 - 2.6694134034794404e-6im, -7.98790998028695e-12 + 3.598727895917374e-10im, 2.897016416213231e-14 - 3.756366219121876e-14im, -6.5011299668892814e-18 + 1.893528183239363e-18im, -7.387860007238956e-21 + 4.307140280135473e-21im, -8.26033451202717e-21 - 6.756127931437794e-21im, -2.5426148062559435e-22 + 2.2339667786924876e-23im],
            atol = 1e-8)

        @test isapprox(
            10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
            [-0.35881759521980744, -0.385117423354259, -0.41414939742059736, -0.446287000021707, -0.4819671494467915, -0.5217030283937181, -0.5660998951592299, -0.615874647014855, -0.6718801157848668, -0.7351353409631514, -0.8068633950031351, -0.8885387326454448, -0.981946491680386, -1.0892566462948559, -1.2131163043297342, -1.3567635274049779, -1.5241654051605997, -1.7201809116540834, -1.9507437678241066, -2.223049145613044, -2.545704629946929, -2.928758390788075, -3.3834221034535448, -3.9211171116996857, -4.551109812451227, -5.275362696077439, -6.078361807708591, -6.909696257133138, -7.662867000085491, -8.174297591310262, -8.287679623630845, -7.968447782809193, -7.3340361934342955, -6.555662050892172, -5.764284340508943, -5.030262411454665, -4.380877515444305, -3.820225951969851, -3.341957987874843, -2.935990192395113, -2.5916846771421826, -2.299202583683047, -2.049972415564228, -1.836752765228121, -1.6535251037110186, -1.4953289766833822, -1.3580907845877932, -1.2384674519708925, -1.1337120464346502, -1.0415619195290984, -0.9601472577112286],
            atol = 1e-8)
    end

end