using JosephsonCircuits
using Test


@testset verbose=true "hbsolve2" begin

    @variables Rleft Cc Lj Cj w L1
    circuit = Tuple{String,String,String,Num}[]
    push!(circuit,("P1","1","0",1))
    push!(circuit,("R1","1","0",Rleft))
    push!(circuit,("C1","1","2",Cc)) 
    push!(circuit,("Lj1","2","0",Lj)) 
    push!(circuit,("C2","2","0",Cj))
    circuitdefs = Dict(
        Lj =>1000.0e-12,
        Cc => 100.0e-15,
        Cj => 1000.0e-15,
        Rleft => 50.0,
    )
    ws = 2*pi*(4.5:0.01:5.0)*1e9
    wp = 2*pi*4.75001*1e9
    Ip = 0.00565e-6
    Nsignalmodes = 8
    Npumpmodes = 8
    result=hbsolve2(ws, wp, Ip, Nsignalmodes, Npumpmodes, circuit, circuitdefs,pumpports=[1])

    ## There is something wrong with hbsolve2 because the difference with v1 is
    # so large
    @test isapprox(
        result.pump.nodeflux,
        ComplexF64[-0.013189687430685906 - 0.008651135043575502im, 2.639598670538948e-5 - 5.666611449141018e-6im, -2.3498766548001166e-8 - 2.2306486650562197e-8im, -7.98943253563643e-12 + 3.749653757553431e-11im, 4.336757164454433e-14 - 1.3391103079731818e-14im, -3.805252315803626e-17 - 3.8516421942690624e-17im, -2.130449776384576e-20 + 4.618696753731368e-20im, 2.8021821773935325e-20 + 1.3775003712485063e-20im, 0.12157339027318752 + 0.07973621371698303im, 1.3738199701264974e-5 - 6.462861731089273e-5im, -5.339502035336453e-8 + 9.18771948944054e-9im, 2.7906788458648864e-11 + 4.514498872493491e-11im, 3.339678445512591e-14 - 4.568185800970342e-14im, -6.151689076374028e-17 - 1.53346634441141e-17im, 2.5039839024709762e-21 + 5.716902094904344e-20im, 3.4175801609630287e-20 + 1.2562610859448766e-21im],
        atol = 1e-8)

    @test isapprox(
        10*log10.(abs2.(result.signal.S[result.signal.signalindex,result.signal.signalindex,:])),
        [0.002717108858946793, 0.0031879520935982402, 0.0037642446185965324, 0.004475383013223682, 0.0053606978269378535, 0.006473444715221922, 0.007886674120213068, 0.009702003437559649, 0.012062955897919649, 0.01517562636626106, 0.019341352421240222, 0.02500950676926198, 0.03286484531385613, 0.043975771610102424, 0.06005302928487789, 0.08391459137857606, 0.12034767823710302, 0.1777602097497067, 0.2714509659029194, 0.4302936705726257, 0.7107802094077564, 1.2271083440171333, 2.2162769935173308, 4.180110108877973, 8.169093934732308, 13.301163085878711, 8.180093144698343, 4.185558851579401, 2.2189671533278914, 1.2284787585772965, 0.7115038536433982, 0.43069070043494184, 0.27167713937135807, 0.1778935882792974, 0.12042875429222956, 0.08396513829127941, 0.06008517528910184, 0.043996501810995445, 0.032878309127231595, 0.025018239887281794, 0.01934694474117187, 0.015179098184663023, 0.012064975809621162, 0.009703017868664187, 0.007886986200931884, 0.006473263379761254, 0.005360169008014386, 0.00447460983580694, 0.0037633006999568362, 0.0031868904434022814, 0.002715967922848746],
        atol = 1e-8)
end
